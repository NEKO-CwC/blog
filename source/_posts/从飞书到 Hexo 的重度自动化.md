---
title: ä»é£ä¹¦åˆ° Hexo çš„é‡åº¦è‡ªåŠ¨åŒ–
abbrlink: a8557e90
---


> å†™åœ¨å‰é¢ï¼šæœ¬ç¯‡æ–‡ç« æ›´å¤šæ˜¯ä¸€ä¸ªè®°å½•è‡ªå·±æŠ˜è…¾çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œé¢å¯èƒ½æ²¡æœ‰å¾ˆç»†è‡´çš„æ•™ç¨‹ç±»çš„å†…å®¹ï¼Œè€Œä¸”ä½ ä¼šçœ‹åˆ°å¾ˆå¤šæ²¡æœ‰å¿…è¦çš„ â€œæ›²çº¿æ•‘å›½â€ã€‚åŒ…æ‹¬ä½†ä¸é™äº
>
> - æœ‰ä¸Šè¡Œå¸¦å®½ä¸ç”¨ï¼Œéè¦å»éƒ¨ç½²åˆ° S3 ä¸Šé¢
> - å«Œè–…æ¥çš„ S3 è¿æ¥è´¨é‡ä¸è¡Œï¼Œæ‰¾äº†å¦ä¸€ä¸ª VPS è¿›è¡Œè½¬å‘å’Œä»£ç†
> - ç”¨ k8s å»èµ·ä¸€ä¸ªåšå®¢
> - å†™äº† n ä¸ªè„šæœ¬è€Œä¸”ä¸²åœ¨ä¸€èµ·ç”¨
> - ci é‡Œé¢å†™äº†å¥½å¤š step è€Œä¸”å¯ç»´æŠ¤æ€§å‡ ä¹ä¸º 0
>   é¡¹ç›®ä»£ç å¤§éƒ¨åˆ†æ˜¯ public çš„ï¼Œä»“åº“[åœ¨è¿™](https://github.com/NEKO-CwC/blog)
>   æ¶æ„å›¾å¦‚ä¸‹ï¼š
>   {% asset_img "CrFpbuP6fomc4txVqr1cpDaqnGj.png" "" %}

## å¼•å…¥ï¼šä¸ºäº†â€œå·æ‡’â€è€Œè¿›è¡Œçš„è¿‡åº¦å·¥ç¨‹

ä½œä¸ºä¸€ä¸ªä¹ æƒ¯äº†äº‘æ–‡æ¡£ä½“éªŒçš„å¼€å‘è€…ï¼Œæˆ‘é¢ä¸´ä¸€ä¸ªéå¸¸å…¸å‹çš„â€œæ—¢è¦åˆè¦â€çš„å›°å¢ƒï¼š

### åŸå§‹éœ€æ±‚ï¼šä¼˜é›…çš„åˆ›ä½œï¼Œè‡ªç”±çš„è¡¨è¾¾

å› ä¸ºæœ€è¿‘ç¡®å®æ²¡ä»€ä¹ˆäº‹æƒ…å¹²ï¼Œå°±æƒ³ç€é‡æ–°ç»´æŠ¤ä¸€ä¸‹ä¹‹å‰é‚£ä¸ªä½å¯ç”¨æ€§çš„ blog ç½‘ç«™~~ï¼ˆä¸¤å¹´å‰çš„è‡ªå·±å½“æ—¶å¤ªèœäº†ï¼Œå•¥ä¹Ÿä¸ä¼šï¼Œå‡ ä¹çº¯æ‰‹åŠ¨ç»´æŠ¤ï¼Œæœ€åä¹ŸåšæŒä¸ä¸‹å»å°±æ‰”äº†ï¼‰~~ï¼Œè®©ä»–æ›´**â€œä¼ä¸šçº§â€ï¼š**

- **å†™ä½œç«¯ï¼š** å¹³æ—¶åœ¨**é£ä¹¦æ–‡æ¡£**ä¸Šé¢å†™ä¸œè¥¿ã€‚å› ä¸ºå¹³æ—¶ç»å¸¸ç”¨é£ä¹¦ï¼Œè€Œä¸”è§‰å¾—ä»–é•¿å¾—å¥½çœ‹ã€‚
- **å±•ç¤ºç«¯ï¼š** æˆ‘é€‰æ‹©äº† **Hexo** é…åˆ **Redefine** ä¸»é¢˜ã€‚å®ƒè¶³å¤Ÿè½»é‡ã€é«˜åº¦å¯å®šåˆ¶ï¼Œè€Œä¸”é•¿å¾—å¥½çœ‹ã€‚

### æ ¸å¿ƒç—›ç‚¹ï¼šå­¤å²›ä¸é—¨æ§›

ç„¶è€Œï¼Œç†æƒ³ä¸ç°å®ä¹‹é—´éš”ç€ä¸‰åº§å¤§å±±ï¼š

- **å¹³å°å­¤å²›ï¼š** é£ä¹¦çš„å†…å®¹æ˜¯é—­ç¯çš„ï¼Œæ— æ³•ç›´æ¥å˜æˆé™æ€ç½‘é¡µã€‚
- **Markdownï¼š** è™½ç„¶ Hexo æ”¯æŒ Markdownï¼Œä½†æ˜¯æ€»æ˜¯è¦å»å…¼å®¹ Hexo çš„è·¯å¾„å¼•ç”¨ï¼Œå›¾ç‰‡èµ„æºå¼•ç”¨ä¹‹ç±»çš„å„ç§ç‰¹æ€§ï¼Œè¿˜è¦äºŒæ¬¡å¤„ç†ï¼Œä¾ç„¶æŒºè´¹åŠ²ã€‚
- **è¿ç»´è´Ÿæ‹…ï¼š** å¦‚æœæ¯æ¬¡å‘å¸ƒéƒ½è¦æ‰‹åŠ¨ç¼–è¯‘ã€æ‰‹åŠ¨ä¸Šä¼ å›¾åºŠã€æ‰‹åŠ¨æ›´æ–° K8s é•œåƒï¼Œé‚£è¿™å¥—ç³»ç»Ÿè¿Ÿæ—©è¿˜ä¼šå› ä¸ºä¹‹å‰ä¸€æ ·çš„åŸå› è¢«æŠ›å¼ƒæ‰ã€‚

### æˆ‘çš„æ–¹æ¡ˆï¼šä¸€å¥—â€œè¿‡åº¦å·¥ç¨‹â€çš„è‡ªåŠ¨åŒ–é“¾è·¯

ä¸ºäº†è®©â€œåœ¨é£ä¹¦å†™å­—â€å’Œâ€œåœ¨ Hexo å‘å¸ƒâ€æ— ç¼è¡”æ¥ï¼Œæˆ‘å†³å®š**ç”¨å¤æ‚çš„è‡ªåŠ¨åŒ–é€»è¾‘æ¢å–æè‡´çš„å‘å¸ƒä½“éªŒ**ã€‚åŒ…æ‹¬ä½†ä¸é™äºï¼š

- **K8s + GitHub Actions** æ­å»ºè‡ªåŠ¨åŒ–çš„å‘å¸ƒæµæ°´çº¿ï¼›
- **Cloudflare R2** + **ngixn proxy cache** æ„å»ºä½æˆæœ¬ã€é«˜æ€§èƒ½çš„å›¾åºŠï¼›
- **N ä¸ªè‡ªç ”è„šæœ¬** è®©é£ä¹¦æ–‡æ¡£åˆ° Hexo é™æ€èµ„æºã€‚

## æ‹©è‰¯æœ¨è€Œæ –ï¼šä¸ºä»€ä¹ˆä¾ç„¶æ˜¯ Hexoï¼Ÿ

é€‰æ‹©æ¡†æ¶çš„æ—¶å€™å€’æ˜¯æ²¡æœ‰ä»€ä¹ˆçº ç»“ï¼Œä¾ç„¶é€‰æ‹©äº†ä¹‹å‰å°±ä¸€ç›´åœ¨ç”¨çš„ [Hexo](https://hexo.io/zh-cn/)ã€‚ä¼˜ç‚¹æœ‰å¾ˆå¤šï¼š

- è€ç‰Œã€ç¤¾ç”Ÿæ€ä¸°å¯Œ
- åŸç”Ÿæ”¯æŒ Markdown ç¼–è¯‘æ¸²æŸ“æˆé™æ€é¡µé¢
- é«˜åº¦è‡ªå®šä¹‰ï¼Œè¿˜èƒ½æ’å…¥å¹¶ä¸”æ³¨å†Œç‹¬ç«‹è¿è¡Œçš„è„šæœ¬åšæ›´å¤šçš„å¤„ç†

å¾—ç›Šäº Hexo å¼ºå¤§çš„ç¤¾åŒºï¼Œé‡Œé¢æœ‰å„å¼å„æ ·çš„ä¸»é¢˜ï¼Œæœ€åå†³å®šäº† [Redefine](https://redefine.ohevan.com/)ã€‚å› ä¸ºä»–è¶³å¤Ÿç°ä»£ï¼Œè¶³å¤Ÿç®€çº¦å¥½çœ‹ã€‚ç®€å•è°ƒæ•´äº†[å…¨å±€è®¾ç½®](https://redefine-docs.ohevan.com/zh/docs)å°±æˆäº†æœ€åçœ‹åˆ°çš„æ ·å­

{% asset_img "SVDxbD4qmoLnKVxjyNccZTmTnLd.png" "" %}

## è‡ªåŠ¨åŒ–é˜²è…ï¼šä»æ‰‹åŠ¨ç¼–è¯‘åˆ°â€œä¸€é”®ä¸‹ç­â€

ç°åœ¨æ¯æ¬¡ä¿®æ”¹åšå®¢æ–‡ç« å†…å®¹åï¼Œéƒ½è¦è‡ªå·±åœ¨æœ¬åœ°è¿›è¡Œç¼–è¯‘ï¼Œç„¶åæ¨åˆ° Dockhub ä¸Šé¢ï¼Œåˆè¦åœ¨æœåŠ¡å™¨ä¸Šé¢æ‹‰ä¸‹æ¥é‡æ–°å¯åŠ¨ã€‚å¾ˆéº»çƒ¦ã€‚

æ‰€ä»¥æˆ‘é€‰æ‹©åœ¨ GitHub åˆ›å»ºä¸€ä¸ª Public çš„ä¸€ä¸ªä»“åº“ï¼Œå› ä¸ºå¯ä»¥è–…åˆ°æ¯ä¸ªæœˆ 2000 åˆ†é’Ÿå…è´¹çš„ action æ—¶é—´ã€‚

å¹¶ä¸”å†™ä¸€ä¸ª [ci](https://github.com/NEKO-CwC/blog/blob/master/.github/workflows/deploy.yml)ï¼Œæ¥è‡ªåŠ¨ç¼–è¯‘å¹¶ä¸”ä¸Šä¼ é•œåƒï¼Œç„¶å ssh æ‰§è¡Œ k8s çš„ deployment é‡å¯ã€‚

> ğŸ’¡ **é‡è¦**
> å› ä¸ºä»“åº“æ˜¯ Public çš„ï¼Œæˆ‘å·²ç»å°†æ‰€æœ‰çš„æ•æ„Ÿä¿¡æ¯éƒ½åœ¨ action secrets é‡Œé¢ä¿å­˜èµ·æ¥äº†ã€‚é¿å…äº†æ‰€æœ‰çš„æ˜æ–‡ä¿å­˜ã€‚

## ç”Ÿäº§åŠ›æ¡¥æ¢ï¼šä»é£ä¹¦æ–‡æ¡£åˆ° Hexo

å› ä¸ºå¹³å¸¸é£ä¹¦ç”¨çš„æ¯”è¾ƒå¤šï¼Œåšæ–‡å­—è®°å½•ä¹Ÿéƒ½åœ¨é£ä¹¦æ–‡æ¡£ï¼Œè€Œä¸”é£ä¹¦æ–‡æ¡£åŸç”Ÿæ”¯æŒ Markdown çš„è¯­æ³•ã€‚å°±æƒ³ç€èƒ½ä¸èƒ½æ‰¾ä¸€ä¸ªå·¥å…·èƒ½å¤ŸååŠ©å¯¼å‡º Markdown æ ¼å¼çš„æ–‡æœ¬ï¼Œæœ€åæ‰¾åˆ°äº† [feishu2md](https://github.com/Wsine/feishu2md)ã€‚

> ä½¿ç”¨æ•™ç¨‹è¯¦è§é¡¹ç›®åœ°å€ï¼Œè¿™é‡Œä¸åšèµ˜è¿°ã€‚
> è™½ç„¶è¿™ä¸ªé¡¹ç›®å·²ç»åœæ­¢ç»´æŠ¤äº†ï¼Œä½†æ˜¯ç°åœ¨å­˜åœ¨çš„åŠŸèƒ½å¯¹äºæœ¬æ¥å‡ ä¹å°±ç”¨ Markdown è¯­æ³•å†™æ–‡æ¡£çš„æˆ‘å·²ç»å®Œå…¨å¤Ÿç”¨äº†ã€‚

ä½†æ˜¯åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œå¾ˆå¿«å°±å‘ç°äº†é—®é¢˜ï¼š

- **å¯¼å‡ºç»“æœä¸åˆé¢„æœŸ**ï¼šfeishu2md å¯¼å‡ºçš„äº‘æ–‡æ¡£ä¼šç›´æ¥å¯¼å‡ºæˆä¸€ä¸ªå•ç‹¬çš„ md æ–‡ä»¶ï¼Œæ‰€æœ‰çš„èµ„æºéƒ½åœ¨ç›¸åŒè·¯å¾„çš„ `static` æ–‡ä»¶å¤¹ä¸‹é¢ï¼Œå¦‚ä¸‹

```bash
â”œâ”€â”€ static
â”‚   â”œâ”€â”€ ET4ibQb6hosg7SxUi8yc7ln2nIg.png
â”‚   â”œâ”€â”€ F78wbHDckoGOSDxqW4ZcjIIwn5d.png
â”‚   â””â”€â”€ Plpab4H1YonocAx9zSwcaMpfnTf.png
â””â”€â”€ Xrp9drgTMo39Gtx6CchcZ9wZn4c.md
```

- **ä¸æ–¹ä¾¿å½’æ¡£**ï¼šå¯¼å‡ºçš„æ–‡ä»¶åæ˜¯å¯¹åº”çš„ UUID ç±»ä¼¼çš„éšæœºå­—**ç¬¦**
- **ä¸å¤Ÿæ‹¿æ¥å°±ç”¨**ï¼šå¯¹äº Hexo æ¥è¯´ï¼Œä»–çš„ md æ–‡ä»¶é‡Œé¢å°‘äº† Front-matter ä¹‹ç±»çš„åšå®¢æ–‡ç«  meta ä¿¡æ¯ï¼Œè¿˜è¦æ‰‹åŠ¨æ·»åŠ 
- **ä¸å¤Ÿæ–¹ä¾¿**~~ï¼šè¿˜è¦æ‰‹åŠ¨ç§»åˆ°ä»“åº“æ–‡ä»¶å¤¹é‡Œé¢~~

è¿™å¤ªä¸ä¼˜é›…äº†ï¼Œä¸ºäº†è‡ªåŠ¨åŒ–ï¼Œå°±éœ€è¦ä¸€ä¸ª[è„šæœ¬](https://github.com/NEKO-CwC/blog/tree/master/util/mdrefactor.py)æ¥å¤„ç†è¿™äº›å†…å®¹ï¼Œç›´æ¥ä»é£ä¹¦æ–‡æ¡£é“¾æ¥åˆ°é¡¹ç›®æ–‡ä»¶å¤¹ä¸­ã€‚

## ç¤¾äº¤é—­ç¯ï¼šæ·»åŠ  Gitalk è¯„è®ºåŒº

æ–‡ç« å‘å¸ƒåªæ˜¯ç¬¬ä¸€æ­¥ï¼Œä¸€ä¸ªæ²¡æœ‰è¯„è®ºåŒºçš„åšå®¢æ˜¯æ²¡æœ‰çµé­‚çš„ã€‚åœ¨ Redefine æ”¯æŒè¯¸å¦‚ walineã€gitalk ç­‰è¯„è®ºç³»ç»Ÿã€‚ç»è¿‡ç®€å•é…ç½®å³å¯åœ¨æ–‡ç« æœ«å°¾çœ‹åˆ°è¯„è®ºåŒºã€‚

{% asset_img "Tdr4bF0OTo1UCwxsZS4cOjvMn0f.png" "" %}

è¿™é‡Œæˆ‘ä»¬é€‰æ‹© Gitalkï¼Œ

- ä»–ä¼šè‡ªåŠ¨æ£€æµ‹å¯¹åº”çš„ä»“åº“é‡Œé¢æ˜¯å¦æœ‰ url é‡Œé¢åŒåçš„ issueï¼Œç„¶åæŠŠé‡Œé¢çš„ comment è¿›è¡ŒåŒæ­¥ã€‚
- ç›¸åŒçš„ï¼Œå‘å¸ƒè¯„è®ºçš„æ—¶å€™ä¹Ÿä¼šç›´æ¥åœ¨ issue åˆ›å»ºæ–°çš„ commentã€‚
- è€Œä¸”ç›´æ¥ä½¿ç”¨ GitHub çš„ OAuth å³å¯ç™»å½•ï¼Œç”šè‡³èŠ‚çœäº†è´¦å·ç³»ç»Ÿã€‚

[Redefine](https://redefine-docs.ohevan.com/zh/docs/posts/comment) çš„æ•™ç¨‹å·²ç»å†™å¾—å¾ˆå¥½äº†ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚

ä½†æ˜¯å¯¹äºæ¯ä¸€ä¸ªæ–°çš„åšå®¢ï¼Œæˆ‘ä»¬éƒ½è¦æ‰‹åŠ¨å» issue é‡Œé¢æ–°å»ºï¼Œè¿™æ¯«æ— ç–‘é—®å¢åŠ äº†æˆ‘ä»¬çš„è¿ç»´æˆæœ¬ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ª[è„šæœ¬](https://github.com/NEKO-CwC/blog/blob/master/ci/gitalk-init.js)ï¼Œå¹¶ä¸”åœ¨ ci é‡Œé¢æ·»åŠ æ‰§è¡Œ

> è¿™ä¸ªè„šæœ¬å°±æ˜¯è‡ªåŠ¨è¯»å–æ–‡ç«  posts æ–‡ä»¶å¤¹ä¸­çš„ md æ–‡ä»¶ï¼Œç„¶åè‡ªåŠ¨å…³è” hexcodeã€‚issue æ ‡é¢˜å†™æ–‡ç« æ ‡é¢˜ã€‚æœ€åå°±èƒ½åœ¨ ci é‡Œé¢è‡ªåŠ¨åˆ›å»ºã€‚

å…³äº Gitalk çš„é…ç½®é‡åˆ°çš„é—®é¢˜æ–‡æœ«æœ‰ç¬”è®°ã€‚

## èµ„æºè¿›åŒ–ï¼šæŠŠæ²‰é‡çš„ç´ æä¸¢ç»™ R2 ä¸ VPS ä»£ç†

éšç€å›¾æ–‡å†…å®¹çš„ç§¯ç´¯ï¼Œæˆ‘å‘ç°å®¹å™¨é•œåƒçš„ä½“ç§¯æ­£åœ¨å˜å¾—è¶Šæ¥è¶Šå¤§

{% asset_img "DMyqb89gToBj4CxbMFGcyDSYnph.png" "" %}

å› ä¸ºæˆ‘ä»¬çš„åšå®¢ç½‘ç«™å¯èƒ½æœ‰å¾ˆå¤šçš„å›¾ç‰‡èµ„æºï¼Œè¿™äº›å›¾ç‰‡èµ„æºä¸€å¼ å°±è¦ 500KBï¼Œä½†æ˜¯æœ¬æ¥åšå®¢çš„å†…å®¹ html å¯èƒ½å°±åªæœ‰ 10+ KBã€‚

- æ¯”å¦‚åŒ…å« 10 å¼ å›¾ç‰‡ï¼Œä½ çš„ä¸€ä¸ªåšå®¢è¯·æ±‚è¦ 500KB * 10 + 10KB çº¦= 5M
- ä½†æ˜¯ä¸åŒ…å«å›¾ç‰‡ä¸»è¦ 10K

è¿™å‡ ä¹å°±æ˜¯ 5M / 10KB = 500 å€çš„ä¸Šè¡Œå¸¦å®½å·®è·ã€‚

å¦‚æœæˆ‘ä»¬çš„åšå®¢ç½‘ç«™åŒæ—¶æœ‰è¿‡å¤šçš„å¹¶å‘è¯·æ±‚ï¼Œå¾ˆå®¹æ˜“å æ»¡ä¸Šè¡Œå¸¦å®½ã€‚æ‰€ä»¥æˆ‘ä»¬æœ‰å¿…è¦è¿ç§»åˆ°ä¸€äº›å¤–éƒ¨çš„äº‘å­˜å‚¨ã€‚

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ CF çš„ [R2](https://developers.cloudflare.com/r2/) å­˜å‚¨ï¼Œä½œä¸ºäº’è”ç½‘å¤§å–„äºº CFï¼Œä»–å¾ˆæ…·æ…¨çš„ç»™äº†ä¸€äº›å…è´¹é¢åº¦ã€‚è®¡ç®—ä¸‹æ¥å¯¹äºå°å‹è®¿é—®é‡çš„åšå®¢å·²ç»å®Œå…¨å¤Ÿç”¨äº†ã€‚

{% asset_img "IIPGb5gvCoeHxexQ066cwShYnOh.png" "" %}

æˆ‘ä»¬åªéœ€è¦

- åœ¨ hexo ç¼–è¯‘ä¹‹åæ‰§è¡Œ[è„šæœ¬](https://github.com/NEKO-CwC/blog/blob/master/scripts/cdn-replace.js)ï¼Œæ›¿æ¢æ‰€æœ‰ html é‡Œé¢çš„åº”è¯¥ä»£ç†çš„èµ„æºä¸º cdn çš„ url
- åœ¨æ‰“åŒ…é•œåƒä¹‹å‰æ‰§è¡Œä¸€ä¸ªé¢å¤–æ‰§è¡Œçš„[è„šæœ¬](https://github.com/NEKO-CwC/blog/blob/master/scripts/hexo-deployer-r2.js)ï¼Œæ¥å°†æ‰€æœ‰çš„é€‰ä¸­èµ„æºï¼ˆå¤§éƒ¨åˆ†æ˜¯å›¾ç‰‡è§†é¢‘ä¹‹ç±»çš„ï¼‰ä¸Šä¼ åˆ° R2 é‡Œé¢ã€‚ç„¶ååœ¨åŸæœ¬çš„ä»“åº“ä¸­åˆ é™¤è¿™äº›èµ„æºã€‚

> ä¸æ˜¯ä¸€å®šè¦æ‰‹æ“ï¼Œæ˜¯å› ä¸ºæ‰¾ä¸åˆ°ç°æˆçš„æ’ä»¶

æˆ‘ä»¬å°±èƒ½ä¿è¯ç¼–è¯‘å‡ºæ¥çš„é•œåƒä¾ç„¶å°ï¼Œåªæœ‰é‡Œé¢çš„åšå®¢æ–‡ç«  htmlã€‚è€Œä¸”ä¸å½±å“æœ¬åœ°çš„å¼€å‘ç¯å¢ƒã€‚

è¿™çœ‹èµ·æ¥å·²ç»å¾ˆå¥½äº†ä¸æ˜¯å—ã€‚ä½†æ˜¯è¿˜æ˜¯ä¼šæœ‰

### é—®é¢˜ï¼š

- CF è™½ç„¶å¯ä»¥é€‰æ‹© Bucket æ‰€åœ¨çš„åœ°åŒºä¸ºäºšå¤ªï¼Œä½†æ˜¯é€šå¸¸æƒ…å†µä¸‹è§£æå‡ºæ¥çš„ ip å¯¹äºå›½å†…çš„è¿æ¥æ•ˆæœå¹¶ä¸å¥½ã€‚ç”šè‡³æ ¹æœ¬æ— æ³•è¿æ¥ã€‚~~ï¼ˆè€Œä¸”é€šå¸¸æƒ…å†µä¸‹ dns ç”šè‡³è¿˜è¦ 400msï¼‰~~

> è¿™é‡Œæ˜¯æˆ‘çš„ cf çš„å‚¨å­˜æ¡¶ç›´è¿çš„æ•ˆæœ
> {% asset_img "T7WYbMZvPoRjhWxGsmqcMLjynRd.png" "" %}

### æ‰€ä»¥ï¼š

ä¸ºäº†æ›´å¥½çš„æ•ˆæœï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ‰¾å¦ä¸€ä¸ª VPS ï¼Œä¸Šé¢éƒ¨ç½²ä¸€ä¸ª nginx proxy cache æ¥åšè½¬å‘ã€‚è®¾ç½®ç¼“å­˜ï¼Œè¿˜èƒ½å‡å°‘æˆ‘ä»¬ R2 ä¸Šé¢çš„ B ç±»è¯·æ±‚ã€‚

> è¿™æ˜¯é…ç½®äº†ä»£ç†å
> {% asset_img "MJdibhz3woe5AExxuKccsPqTnpb.png" "" %}

## ç»“è¯­ï¼šè®©å¤æ‚ç•™åœ¨åº•å±‚ï¼Œè®©ç®€æ´å›å½’åˆ›ä½œ

ä¸ºäº†è®©åšå®¢ç½‘ç«™å›å½’ä»–çº¯ç²¹çš„æ ·å­ï¼Œè®©æˆ‘ä»¬ä¸“æ³¨äºå†™åšå®¢ï¼Œå‰©ä½™çš„ç»´æŠ¤æˆ‘ä»¬å°½é‡ä¸åšã€‚

æˆ‘ä¸å†éœ€è¦å…³å¿ƒå›¾ç‰‡å­˜å“ªã€ç¯å¢ƒæ€ä¹ˆé…ã€æˆ–è€… Issue æ€ä¹ˆå»ºã€‚ç°åœ¨ï¼Œåªéœ€è¦åœ¨é£ä¹¦å†™å®Œæ–‡ç« ï¼Œæ‰§è¡Œä¸€ä¸‹è„šæœ¬å¯¼å‡ºå¹¶ `git push`ï¼Œå‰©ä¸‹çš„äº‹æƒ…ï¼Œå°±äº¤ç»™é‚£äº›å¤æ‚çš„â€œè¿‡åº¦å·¥ç¨‹â€äº†ã€‚

## èµ„æºé“¾æ¥

### é£ä¹¦æ–‡æ¡£è½¬æ¢å’Œè¿ç§»[è„šæœ¬](https://github.com/NEKO-CwC/blog/tree/master/util/mdrefactor.py)

è„šæœ¬éœ€è¦å¯ä»¥è‡ªå–ï¼Œç”¨æ³•æ˜¯ï¼š

åœ¨ä¸€ä¸ªæœ‰ä¸”ä»…èƒ½æœ‰ä¸€ä¸ª md æ–‡ä»¶å’Œä¸€ä¸ªåå­—ä¸º static çš„æ–‡ä»¶å¤¹ä¸‹è¿è¡Œ

`python mdrefactor.py <work_dir> --dest <posts_dir>`

å°±ä¼šè‡ªåŠ¨é‡æ„

- é‡å‘½å md æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ä¸ºä¸€çº§æ ‡é¢˜
- åˆ é™¤ md æ–‡ä»¶ä¸­çš„ä¸€çº§æ ‡é¢˜ï¼Œç”¨ Front-matter è¿›è¡Œæ›¿æ¢
- æ›¿æ¢ md æ–‡ä»¶é‡Œçš„ `> [TIP]` ä¸º `> ğŸ’¡ **é‡è¦`******
- æ›¿æ¢å›¾ç‰‡å¼•ç”¨ä¸º hexo çš„ `{% asset_img "<url>" "<describe>" %}`
- ç„¶åæŠŠ md å’Œç´ æå¤åˆ¶åˆ°ä½ çš„ dest ç›®å½•é‡Œé¢

ä¸ºäº†è®© hexo è‡ªåŠ¨è¯†åˆ«è¿™ç§åŒå md å’ŒåŒåæ–‡ä»¶å¤¹ï¼Œè¿˜éœ€è¦ä¿®æ”¹ `_config.yml`

```yaml
post_asset_folder: true
```

### Nginx Proxy Cache

ç›´æ¥ç”¨ docker èµ·ä¸€ä¸ªï¼Œç„¶åæŒ‚ä¸ªè¯ä¹¦å³å¯

```yaml
# 10GB ç¡¬ç›˜ç¼“å­˜ï¼Œ10MB å†…å­˜ç´¢å¼•
# è¯·æ ¹æ®æœåŠ¡å™¨ç£ç›˜ç©ºé—´è°ƒæ•´ max_size
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=resource_cache:10m max_size=10g inactive=7d use_temp_path=off;

# æŒ‡å®š DNS è§£æå™¨ï¼ˆå¿…é¡»ï¼Œç”¨äºè§£æåŠ¨æ€æå–çš„å˜é‡åŸŸåï¼‰
resolver 1.1.1.1 8.8.8.8 valid=300s;
resolver_timeout 5s;

server {
    listen 80;
    server_name proxy.yourdomain.com; # [æ›¿æ¢] ä½ çš„ä»£ç†åŸŸå
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    server_name proxy.yourdomain.com; # [æ›¿æ¢] ä½ çš„ä»£ç†åŸŸå

    # [æ›¿æ¢] è¯ä¹¦å®é™…å­˜æ”¾è·¯å¾„
    ssl_certificate     /path/to/your/fullchain.pem; 
    ssl_certificate_key /path/to/your/privkey.pem;

    # é‡è¦ï¼šç¦æ­¢åˆå¹¶åŒæ–œæ ï¼Œç¡®ä¿èƒ½æ­£ç¡®è§£æ URL ä¸­çš„ http:// éƒ¨åˆ†
    merge_slashes off;

    # æ­£åˆ™æå–ï¼š$1=åè®®, $t_host=åŸŸå, $t_path=è·¯å¾„
    # æœ«å°¾çš„ ? å…è®¸è·¯å¾„ä¸ºç©ºï¼Œé¿å…è¯·æ±‚æœ«å°¾æ— æ–œæ æ—¶æŠ¥ 404
    location ~* ^/(https?):/+(?P<t_host>[^/]+)(?P<t_path>/.*)?$ {
        
        # é˜²ç›—é“¾é€»è¾‘ï¼šåªå…è®¸è‡ªå·±çš„åŸŸåä½œä¸ºæ¥æº
        # ç§»é™¤äº† none ä»¥ç¦æ­¢ç›´æ¥åœ¨æµè§ˆå™¨æ‰“å¼€ï¼ˆè§†éœ€æ±‚å¼€å¯ï¼‰
        valid_referers server_names ~\.yourblog\.com; # [æ›¿æ¢] ä½ çš„åšå®¢åŸŸåæ­£åˆ™
        if ($invalid_referer) {
            return 403;
        }

        # æ„å»ºæœ€ç»ˆç›®æ ‡ URL
        set $target_url "$1://$t_host$t_path$is_args$args";

        # æ ¸å¿ƒè½¬å‘é€»è¾‘
        proxy_pass $target_url;
        
        # åŠ¨æ€è®¾ç½® Host å¤´éƒ¨ï¼Œç¡®ä¿åç«¯ï¼ˆå¦‚ R2/S3ï¼‰èƒ½è¯†åˆ«åŸŸå
        proxy_set_header Host $t_host;
        
        # å¼€å¯ SNI æ”¯æŒï¼šè§£å†³ç›®æ ‡ç«™ä¸º HTTPS æ—¶çš„æ¡æ‰‹é—®é¢˜
        proxy_ssl_server_name on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;

        # ç¼“å­˜è®¾ç½®
        proxy_cache resource_cache;
        proxy_cache_valid 200 302 30d;
        proxy_cache_key $target_url;
        
        # åœ¨å“åº”å¤´ä¸­æ˜¾ç¤ºç¼“å­˜å‘½ä¸­çŠ¶æ€ï¼Œæ–¹ä¾¿è°ƒè¯•
        add_header X-Cache-Status $upstream_cache_status;
        
        # ç¼“å†²åŒºè°ƒä¼˜ï¼Œé˜²æ­¢å¤§æ–‡ä»¶å¤„ç†å¤±è´¥
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        
        # æµè§ˆå™¨ç¼“å­˜æ§åˆ¶
        expires 30d;
    }

    # å…œåº•é€»è¾‘ï¼šéä»£ç†æ ¼å¼çš„è¯·æ±‚ç›´æ¥è¿”å› 404
    location / {
        return 404;
    }
}
```

## è¸©å‘æŒ‡å—

### å› ä¸º Github çš„ issue æœ‰å­—æ•°é™åˆ¶ï¼Œå¾ˆé•¿çš„åŒ…å«ä¸­æ–‡çš„ url ç»è¿‡ encode ä¼šå˜å¾—å¾ˆé•¿å¾ˆéš¾çœ‹ï¼š

egï¼šä¸€ä¸ªåä¸º `å¦‚ä½•ä¼˜é›…çš„è®© mihomo å’Œä½ çš„å®¹å™¨ä¸­çš„å…¶ä»–æœåŠ¡å…±å­˜` çš„æ–‡ç« ç»è¿‡ encode ä¹‹åä¼šå˜æˆ `%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E8%AE%A9%20mihomo%20%E5%92%8C%E4%BD%A0%E7%9A%84%E5%AE%B9%E5%99%A8%E4%B8%AD%E7%9A%84%E5%85%B6%E4%BB%96%E6%9C%8D%E5%8A%A1%E5%85%B1%E5%AD%98`

- è¿™ä¸ä»…åœ¨ issue é‡Œé¢å¾ˆéš¾çœ‹ï¼Œæ ¹æœ¬ä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ–‡ç« 
- è€Œä¸”é•¿åº¦ä¹Ÿè¶…è¿‡äº†é™åˆ¶ï¼Œå¤§å¤šæ•°æƒ…å†µæ ¹æœ¬æ— æ³•æ­£å¸¸åˆ›å»º issue

æ‰€ä»¥å¯ä»¥ä½¿ç”¨ [hexo-abbrlink](https://github.com/ohroy/hexo-abbrlink) è¿™ä¸ªæ’ä»¶è¿›è¡Œå¤„ç†ã€‚ä»–èƒ½å¤Ÿæ ¹æ®æ¯ä¸ªæ–‡ç« çš„ meta æ•°æ®è®¡ç®—ä¸€ä¸ªå‡ ä¹ä¸ä¼šé‡å¤çš„ hexcodeï¼Œç„¶åå°†è¿™ä¸ª hexcode ä½œä¸º url çš„å‚æ•°è¿›è¡Œç¼–è¯‘ã€‚

### å‰ç«¯é¡µé¢å› ä¸ºæµè§ˆå™¨çš„ CORS é™åˆ¶ï¼Œæ— æ³•æ­£ç¡®è¯·æ±‚ GitHub çš„ apiï¼Œä¼šè¢« Block æ‰

{% asset_img "N9MfbhGxZodajhxCBL0cw8y6nRh.png" "" %}

æˆ‘ä»¬å¯ä»¥é€‰æ‹©å…¬å…±çš„ github ä»£ç†~~ï¼ˆä½†æ˜¯å¯ç”¨æ€§ä¸ä¸€å®šå¦‚ä½•ï¼‰~~æˆ–è€…åœ¨æœåŠ¡å™¨ä¸Šé¢éƒ¨ç½²ä¸€ä¸ª [cors-anywhere](https://hub.docker.com/r/testcab/cors-anywhere)ã€‚ç„¶åå°† `_config.redefine.yml` ä¸­çš„ `comment.config.gitalk.proxy` æ”¹æˆæˆ‘ä»¬ç»è¿‡ä»£ç†åçš„ url

```yaml
gitalk:
      clientID: <your-client-id> 
      clientSecret: <your-client-secret> 
      repo: blog 
      owner: NEKO-CwC 
      proxy: https://cors.neko-dashboard.com:8443/https://github.com/login/oauth/access_token
```

> ğŸ’¡ **é‡è¦**
> ç”¨ k8s çš„ ingress nginx è¿›è¡Œåå‘ä»£ç†æˆ‘ä»¬çš„ cors-anywhere çš„æ—¶å€™ï¼Œå› ä¸º Nginx Ingress Controller é»˜è®¤åˆ†é…çš„ Buffer æœ‰é™~~ï¼ˆç”šè‡³æœ‰ç‚¹è¿‡å°äº†ï¼‰~~ï¼Œå¯¼è‡´è¯·æ±‚çš„ç¼“å†²åŒºæº¢å‡ºã€‚
> Gitalk çš„ OAuth è¯·æ±‚åŒ…å«äº†è¾ƒé•¿çš„ `client_id`ã€`client_secret` å’Œ `code`ã€‚ç¼“å†²åŒºæº¢å‡ºåå…¶ç›´æ¥æ–­å¼€ä¸åç«¯ Pod çš„è¿æ¥ï¼Œä»è€ŒæŠ›å‡º **502 Bad Gateway**

> æ‰€ä»¥è¦æ·»åŠ  ingress çš„ annotation

> ```yaml
> ```

annotations:

# å¢åŠ  Header ç¼“å†²åŒº

nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
nginx.ingress.kubernetes.io/proxy-buffers-number: "4"
nginx.ingress.kubernetes.io/proxy-busy-buffers-size: "256k"

```



```
